<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Pembeli - KantinITH</title>
  <link rel="stylesheet" href="../css/buyer.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="../aset/logo.png" alt="KantinITH Logo" class="logo">
        <h2>KantinITH</h2>
      </div>
      <nav>
        <a href="#" class="active"><i class="uil uil-estate"></i> Dashboard</a>
        <a href="saldo.html"><i class="uil uil-wallet"></i> Saldo</a>
        <a href="#" onclick="logout()"><i class="uil uil-sign-out-alt"></i> Logout</a>
      </nav>
    </aside>

    <div class="main">
      <div class="content-area">
        <header class="topbar">
          <div class="search-box">
            <input type="text" placeholder="Cari menu..." onkeyup="cariMenu(this.value)">
          </div>
          <div class="topbar-right">
            <div class="saldo-box">
              Saldo: <span id="saldo">Rp 50.000</span> <button onclick="tambahSaldo()">+</button>
            </div>
            <div class="topbar-actions">
              <div class="icon" onclick="toggleKeranjang()">
                🛒
                <span class="badge" id="keranjang-badge">0</span>
              </div>
              <div class="profile" onclick="toggleProfile()">
                <div class="profile-icon">👤</div>
                <span class="profile-name"></span>
              </div>
            </div>
          </div>
        </header>

        <div class="profile-dropdown" id="profileDropdown">
          <a href="#" onclick="showProfileInfoPopup(); return false;"><span>👤</span> Profile</a>
          <a href="#"><span>📱</span> Bantuan</a>
          <a href="#" onclick="logout()"><span>🚪</span> Logout</a>
        </div>

        <h3 class="judul">Kategori</h3>
        <div class="kategori">
          <button onclick="filterKategori('Semua')" class="active">Semua</button>
          <button onclick="filterKategori('Makanan')">Makanan</button>
          <button onclick="filterKategori('Minuman')">Minuman</button>
        </div>

        <h3 class="judul">Daftar Menu</h3>
        <div id="menu-list" class="menu-grid">
          <!-- Menu items will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Keranjang sebagai overlay -->
  <div class="keranjang-overlay" id="keranjangOverlay" style="display:none;">
    <div class="keranjang-box">
      <h4>Keranjang Anda <span style="float:right; cursor:pointer;" onclick="toggleKeranjang()">✖</span></h4>
      <ul id="daftar-keranjang"></ul>
      <p>Total: Rp <span id="total">0</span></p>
      <button class="checkout" onclick="checkout()">Checkout</button>
    </div>
  </div>

  <!-- Popup Checkout -->
  <div class="popup-overlay" id="checkoutPopup" style="display:none;">
    <div class="popup-box">
      <div class="popup-header">
        <h3>Konfirmasi Checkout</h3>
        <span class="close-popup" onclick="closePopup('checkoutPopup')">✖</span>
      </div>
      <div class="popup-content">
        <div class="checkout-summary">
          <h4>Ringkasan Pesanan</h4>
          <div id="checkout-items"></div>
          <div class="checkout-total">
            <span>Total Pembayaran:</span>
            <span id="checkout-total-amount">Rp 0</span>
          </div>
        </div>
        <div class="checkout-actions">
          <button class="cancel-btn" onclick="closePopup('checkoutPopup')">Batal</button>
          <button class="confirm-btn" onclick="confirmCheckout()">Bayar Sekarang</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Saldo Kurang -->
  <div class="popup-overlay" id="saldoPopup" style="display:none;">
    <div class="popup-box">
      <div class="popup-header">
        <h3>Saldo Tidak Mencukupi</h3>
        <span class="close-popup" onclick="closePopup('saldoPopup')">✖</span>
      </div>
      <div class="popup-content">
        <div class="saldo-warning">
          <div class="warning-icon">⚠️</div>
          <p>Saldo Anda tidak mencukupi untuk melakukan pembayaran ini.</p>
          <div class="saldo-info">
            <span>Saldo Anda:</span>
            <span id="current-saldo">Rp 0</span>
          </div>
          <div class="saldo-info">
            <span>Total Pembayaran:</span>
            <span id="required-saldo">Rp 0</span>
          </div>
        </div>
        <div class="checkout-actions">
          <button class="cancel-btn" onclick="closePopup('saldoPopup')">Tutup</button>
          <button class="topup-btn" onclick="tambahSaldo()">Tambah Saldo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Sukses -->
  <div class="success-popup" id="successPopup" style="display:none;">
    <span class="success-icon">✅</span>
    <span class="success-message">Checkout berhasil!</span>
  </div>

  <!-- Popup Profil Info -->
  <div class="popup-overlay" id="profileInfoPopup" style="display:none;">
    <div class="popup-box">
      <div class="popup-header">
        <h3>Profil Pengguna</h3>
        <span class="close-popup" onclick="closePopup('profileInfoPopup')">✖</span>
      </div>
      <div class="popup-content">
        <div class="user-info">
          <div class="user-avatar">👤</div>
          <h4 class="user-name" id="profileInfoUserName"></h4>
          <p class="user-role" id="profileInfoUserRole"></p>
        </div>
        <!-- Add more profile info here if available -->
        <div class="profile-details">
            <p><strong>Email:</strong> <span id="profileInfoEmail">email@example.com</span></p>
            <p><strong>Nomor Telepon:</strong> <span id="profileInfoPhone">081234567890</span></p>
            <!-- Add other details as needed -->
        </div>
        <div class="checkout-actions">
            <button class="cancel-btn" onclick="closePopup('profileInfoPopup')">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Popup -->
  <div id="logoutPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
      <div class="popup-header">
        <h3>Konfirmasi Logout</h3>
        <span class="close-popup" onclick="closePopup('logoutPopup')">✖</span>
      </div>
      <div class="popup-content">
        <div class="user-info">
          <div class="user-avatar">👤</div>
          <h4 class="user-name" id="logoutUserName"></h4>
          <p class="user-role" id="logoutUserRole"></p>
        </div>
        <p class="logout-message">
          Apakah Anda yakin ingin keluar dari sistem?
        </p>
        <div class="checkout-actions">
          <button class="cancel-btn" onclick="closePopup('logoutPopup')">Tidak</button>
          <button class="confirm-btn" onclick="confirmLogout()">Ya, Keluar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Data menu (will be fetched from backend)
    let menuItems = []; // Initialize as empty array

    const keranjang = [];

    // Inisialisasi halaman
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded. Initializing...'); // Log
        // Mengambil userId dan role dari localStorage
        const userIdCheck = localStorage.getItem('loggedInUserId');
        const userRole = localStorage.getItem('loggedInUserRole');
        console.log('Initial check: userId in localStorage:', userIdCheck); // Log penting
        console.log('User role:', userRole); // Log role

        // Jika tidak ada userId di localStorage atau role bukan buyer, arahkan ke halaman login
        if (!userIdCheck || userRole !== 'buyer') {
            console.warn('Invalid access: No loggedInUserId found or wrong role. Redirecting to login.');
            localStorage.clear(); // Clear invalid session
            window.location.href = "../index.html";
            return;
        }

        fetchMenu();
        updateSaldo(); // Fetch saldo from backend
        updateKeranjang(); // Update keranjang display on load

        // Update nama profil di topbar saat halaman dimuat
        const profileNameSpan = document.querySelector('.profile-name');
        const loggedInUsername = localStorage.getItem('loggedInUsername');
        if (profileNameSpan && loggedInUsername) {
            profileNameSpan.textContent = loggedInUsername;
        } else if (profileNameSpan) {
            // Tampilkan placeholder jika username tidak ada di localStorage
            profileNameSpan.textContent = 'Pengguna'; // Placeholder
        }
         // Memuat informasi profil ke dalam popup saat halaman dimuat (jika diperlukan)
         // updateProfileInfoPopup(); // Panggil fungsi ini jika ada dan diperlukan saat load
    });

    // Function to fetch menu items from backend
    function fetchMenu() {
        console.log('Fetching menu from backend via login.php with action="get_menu"'); // Log
        fetch('../backend/login.php', { // Pastikan URL ini benar
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'get_menu' }) // Pastikan action ini terkirim
        })
            .then(response => {
                 console.log('Fetch menu response status:', response.status); // Log
                 if (!response.ok) {
                     return response.text().then(text => {
                         console.error('HTTP error fetching menu. Response text:', text); // Log
                         throw new Error(`HTTP error! status: ${response.status}, Response: ${text}`);
                     });
                 }
                 return response.json();
            })
            .then(data => {
                console.log('Data received for menu:', data); // Log data aktual
                // backend/login.php action get_menu mengembalikan array langsung
                if (Array.isArray(data)) {
                    menuItems = data; // *** Penting: Array global ini terisi dengan SEMUA menu ***
                    console.log('Menu items successfully parsed and stored in global menuItems:', menuItems); // Log isi array global

                    if (menuItems.length > 0) {
                         renderMenu(menuItems); // Render SEMUA menu pertama kali
                         const allButton = document.querySelector('.kategori button');
                         if (allButton) {
                              allButton.classList.add('active');
                         }
                    } else {
                         console.log('Backend returned an empty menu array.'); // Log
                         document.getElementById("menu-list").innerHTML = '<p>Tidak ada menu yang tersedia saat ini.</p>';
                    }

                } else if (data && data.status === 'error') { // Tangani respons error dari backend
                     console.error('Backend reported error fetching menu:', data.message, data); // Log error backend
                     document.getElementById("menu-list").innerHTML = `<p>Gagal memuat menu: ${data.message}.</p>`;
                }
                 else { // Tangani format data yang tidak valid
                    console.error('Failed to fetch menu items: Data is not an array or error object', data); // Log data tidak valid
                    document.getElementById("menu-list").innerHTML = `<p>Gagal memuat menu: Format data tidak valid dari server.</p>`;
                }
            })
            .catch(error => {
                console.error('Error fetching menu items:', error); // Log error fetch
                document.getElementById("menu-list").innerHTML = `<p>Gagal memuat menu. Error: ${error.message}. Silakan coba lagi nanti.</p>`;
            });
    }

    // itemsToRender: array item yang akan ditampilkan di UI (bisa hasil filter)
    function renderMenu(itemsToRender) {
        console.log('Rendering menu with items:', itemsToRender); // Log array yang akan dirender
        const menuList = document.getElementById("menu-list");
        if (!menuList) {
            console.error('Menu list element (#menu-list) not found!'); // Log
            return;
        }

        if (!itemsToRender || itemsToRender.length === 0) {
            menuList.innerHTML = '<p>Tidak ada menu yang tersedia.</p>';
            console.log('No items to render.'); // Log
            return;
        }

        menuList.innerHTML = itemsToRender.map(item => {
             // Pastikan item memiliki properti yang dibutuhkan dengan pemeriksaan tipe yang lebih ketat
             if (item === null || typeof item !== 'object' || item.id === undefined || item.id === null || !item.nama || item.harga === undefined || item.harga === null || !item.kategori) {
                  console.error('Invalid item structure encountered during rendering:', item); // Log item yang rusak
                  return '';
             }
             // Log ID yang digunakan di tombol - Terlalu verbose, matikan defaultnya
             // console.log(`Rendering item "${item.nama}" with ID ${item.id}.`);

            return `
            <div class="menu-card" data-kategori="${item.kategori}">
                <img src="../aset/nasi_goreng.jpg" alt="${item.nama}">
                <h4>${item.nama}</h4>
                <p>Rp ${parseFloat(item.harga).toLocaleString()}</p> <!-- Pastikan harga dirender dengan benar -->
                <div class="buttons">
                    <button class="primary" onclick="beliLangsung(${item.id})">Beli Sekarang</button> <!-- Gunakan item.id -->
                    <button class="secondary" onclick="tambahKeranjang(${item.id})">+ Keranjang</button> <!-- Gunakan item.id -->
                </div>
            </div>
        `;
        }).join('');
         console.log('Finished rendering menu.'); // Log
    }

    // kat: kategori yang dipilih (e.g., 'Makanan', 'Minuman', 'Semua')
    function filterKategori(kat) {
        console.log('Filtering by category:', kat); // Log kategori yang diklik
        // Update active button
        document.querySelectorAll('.kategori button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent === kat) btn.classList.add('active');
        });

        // Filter berdasarkan kategori dari menuItems global (yang lengkap)
        const filteredItems = (kat === "Semua")
            ? menuItems // Menggunakan array global menuItems yang lengkap
            : menuItems.filter(item => { // Filtering dari array global
                 // Pastikan item dan item.kategori ada dan cocok
                 return item && item.kategori && item.kategori === kat;
            });

        console.log('Filtered items result:', filteredItems); // Log hasil filter (array yang akan dirender)
        renderMenu(filteredItems); // Meneruskan array hasil filter ke renderMenu
        // *** array menuItems global TIDAK berubah di sini, HANYA tampilan yang berubah ***
    }

    // keyword: teks pencarian
    function cariMenu(keyword) {
        console.log('Searching for keyword:', keyword); // Log
        // Cari berdasarkan keyword di menuItems global (yang lengkap)
        const filtered = menuItems.filter(item =>
             // Pastikan item dan item.nama ada sebelum memanggil toLowerCase
             item && item.nama && item.nama.toLowerCase().includes(keyword.toLowerCase())
        );
        console.log('Search results:', filtered); // Log
        renderMenu(filtered);
        // *** array menuItems global TIDAK berubah di sini, HANYA tampilan yang berubah ***
    }

    // Fungsi untuk menampilkan/menyembunyikan overlay keranjang
    function toggleKeranjang() {
      console.log('Toggling keranjang overlay'); // Log
      const box = document.getElementById("keranjangOverlay");
      if (box) { // Pastikan elemen keranjang overlay ditemukan
           // Toggle display antara none dan flex
           box.style.display = box.style.display === "none" ? "flex" : "none";
           console.log('Keranjang overlay display set to:', box.style.display); // Log status display
      } else {
           console.error('Keranjang overlay element (#keranjangOverlay) not found!'); // Log error jika tidak ditemukan
      }
    }

    // id: ID item menu yang ditambahkan
    function tambahKeranjang(id) {
      console.log('tambahKeranjang called with ID:', id); // Log ID yang diterima
      console.log('Current global menuItems array (for lookup):', menuItems); // Log isi menuItems global

      // *** Penting: Cari item di array global menuItems, bandingkan ID sebagai angka ***
      // Menggunakan find dengan parseInt untuk memastikan perbandingan tipe data
      const item = menuItems.find(i => parseInt(i.id) === parseInt(id));
      console.log('Item found in menuItems for ID:', id, item); // Log hasil pencarian

        if (!item) {
            console.error('Item not found in global menuItems array for ID:', id); // Log error jika tidak ditemukan
            alert(`Menu dengan ID ${id} tidak ditemukan. Silakan refresh halaman.`); // Feedback ke user
            return;
        }

        // *** Penting: Cari item di keranjang, bandingkan ID sebagai angka ***
        const existingItemIndex = keranjang.findIndex(i => parseInt(i.id) === parseInt(id));

        if (existingItemIndex > -1) {
            // Jika item sudah ada di keranjang, tambahkan jumlahnya
            keranjang[existingItemIndex].jumlah++;
            // Hitung ulang total untuk item ini
            keranjang[existingItemIndex].total = parseFloat(keranjang[existingItemIndex].harga) * keranjang[existingItemIndex].jumlah;
             console.log('Item already in cart, quantity increased.'); // Log
        } else {
            // Jika item belum ada, tambahkan sebagai item baru
            keranjang.push({
                id: parseInt(item.id), // Simpan ID sebagai angka
                nama: item.nama,
                harga: parseFloat(item.harga), // Simpan harga sebagai angka
                jumlah: 1,
                total: parseFloat(item.harga) // Total awal = harga
            });
             console.log('New item added to cart.'); // Log
        }

        updateKeranjang(); // Perbarui tampilan keranjang
         console.log('Item added/updated in keranjang. Current keranjang:', keranjang); // Log isi keranjang
    }

    // id: ID item yang dihapus dari keranjang
    function hapusDariKeranjang(id) {
      console.log('hapusDariKeranjang called with ID:', id); // Log
      console.log('Current keranjang before removal:', keranjang); // Log
      // *** Penting: Cari item di keranjang, bandingkan ID sebagai angka ***
      const index = keranjang.findIndex(item => parseInt(item.id) === parseInt(id));
      if (index > -1) {
        keranjang.splice(index, 1); // Hapus item dari array
        updateKeranjang(); // Perbarui tampilan keranjang
         console.log('Item removed from keranjang. Current keranjang:', keranjang); // Log
      } else {
         console.warn('Item not found in keranjang for removal for ID:', id); // Log peringatan
      }
    }

    // Memperbarui tampilan daftar item di keranjang dan total, serta badge ikon
    function updateKeranjang() {
      console.log('Updating keranjang display...'); // Log start
      const list = document.getElementById("daftar-keranjang");
      const totalSpan = document.getElementById("total");
      const badgeSpan = document.getElementById("keranjang-badge"); // Badge di ikon topbar

      if (!list || !totalSpan || !badgeSpan) {
            console.error('Keranjang display elements not found! (#daftar-keranjang, #total, #keranjang-badge)'); // Log error jika elemen tidak ditemukan
            return;
      }

      list.innerHTML = ""; // Kosongkan daftar keranjang saat ini
      let totalHarga = 0;
      let totalJumlahItem = 0; // Variabel untuk total jumlah item

      if (keranjang.length === 0) {
          list.innerHTML = '<li>Keranjang kosong</li>';
          console.log('Keranjang is empty.'); // Log
      } else {
           keranjang.forEach(item => {
            // Pastikan data di keranjang valid sebelum dirender
            if (!item || typeof item !== 'object' || !item.nama || typeof item.jumlah !== 'number' || typeof item.total !== 'number') {
                 console.error('Invalid item structure in keranjang for rendering:', item); // Log item rusak
                 return; // Lewati item yang rusak
            }
            const li = document.createElement("li");
            // Gunakan toLocaleString dengan 'id-ID' untuk format mata uang Indonesia
            li.innerHTML = `
              <div class="keranjang-item">
                <div class="item-info">
                  <div>${item.nama}</div>
                  <div>Rp ${parseFloat(item.harga).toLocaleString('id-ID')} x ${item.jumlah}</div> <!-- Tampilkan harga per item -->
                </div>
                <div class="item-actions">
                  <span>Rp ${parseFloat(item.total).toLocaleString('id-ID')}</span> <!-- Tampilkan subtotal item -->
                  <button onclick="hapusDariKeranjang(${item.id})">🗑️</button> <!-- Gunakan item.id -->
                </div>
              </div>
            `;
            list.appendChild(li);
            totalHarga += item.total; // Tambahkan ke total harga keseluruhan
            totalJumlahItem += item.jumlah; // Tambahkan ke total jumlah item
          });
          console.log(`Rendered ${keranjang.length} distinct items in keranjang.`); // Log jumlah item unik
      }

      // Perbarui total harga di UI dengan format mata uang Indonesia
      totalSpan.textContent = totalHarga.toLocaleString('id-ID');
      
      // Perbarui badge dengan total JUMLAH semua item
      badgeSpan.textContent = totalJumlahItem; 
      
      console.log('Keranjang display updated. Total Quantity:', totalJumlahItem, 'Total Price:', totalHarga); // Log hasil update
      console.log('Updating keranjang display finished.'); // Log end
    }

    // id: ID item menu yang dibeli langsung
    function beliLangsung(id) {
      console.log('beliLangsung called with ID:', id); // Log ID yang diterima
      console.log('Current global menuItems array (for lookup):', menuItems); // Log isi menuItems global

      // *** Penting: Cari item di array global menuItems, bandingkan ID sebagai angka ***
      const item = menuItems.find(i => parseInt(i.id) === parseInt(id));
      console.log('Item found in menuItems for ID:', id, item); // Log hasil pencarian

        if (!item) {
            console.error('Item not found in global menuItems array for ID:', id); // Log error jika tidak ditemukan
            alert(`Menu dengan ID ${id} tidak ditemukan. Silakan refresh halaman.`); // Feedback ke user
            return;
        }

        // Buat keranjang sementara dengan item ini
        const tempKeranjang = [{
            id: parseInt(item.id), // Simpan ID sebagai angka
            nama: item.nama,
            harga: parseFloat(item.harga), // Simpan harga sebagai angka
            jumlah: 1,
            total: parseFloat(item.harga) // Total = harga item * jumlah
        }];

        console.log('Processing direct buy with temp cart:', tempKeranjang); // Log
        processCheckout(tempKeranjang); // Lanjutkan ke proses checkout
    }

    // itemsToCheckout: array item yang akan dicheckout (bisa dari keranjang utama atau beli langsung)
    function processCheckout(itemsToCheckout) {
        console.log('Processing checkout with items:', itemsToCheckout); // Log
        if (!itemsToCheckout || itemsToCheckout.length === 0) { // Periksa jika array kosong atau null
            alert("Tidak ada item untuk checkout.");
            console.warn("processCheckout called with empty or null items array."); // Log
            return;
        }

        // Hitung total harga dari array itemsToCheckout
        const totalHarga = itemsToCheckout.reduce((sum, item) => {
             // Pastikan item di array memiliki total bertipe number
             if (item && typeof item.total === 'number') {
                  return sum + item.total;
             } else {
                  console.error('Invalid item total in itemsToCheckout:', item); // Log item rusak
                  return sum; // Lewati item rusak
             }
        }, 0);

        console.log('Calculated total price for checkout display:', totalHarga); // Log

        // Display checkout confirmation popup
        const checkoutItemsDiv = document.getElementById("checkout-items");
        const checkoutTotalAmountSpan = document.getElementById("checkout-total-amount");
        const checkoutPopup = document.getElementById("checkoutPopup");

        if (!checkoutItemsDiv || !checkoutTotalAmountSpan || !checkoutPopup) {
             console.error('Checkout popup elements not found! (#checkout-items, #checkout-total-amount, #checkoutPopup)'); // Log
             alert("Terjadi kesalahan pada tampilan checkout.");
             return;
        }

        checkoutItemsDiv.innerHTML = itemsToCheckout.map(item => {
             // Pastikan data item valid untuk tampilan ringkasan
             if (!item || typeof item !== 'object' || !item.nama || typeof item.jumlah !== 'number' || typeof item.total !== 'number') {
                  console.error('Invalid item structure for checkout summary display:', item); // Log
                  return ''; // Lewati item rusak
             }
            return `
              <div class="checkout-item">
                <span>${item.nama} x${item.jumlah}</span>
                <span>Rp ${parseFloat(item.total).toLocaleString()}</span> <!-- Tampilkan subtotal item -->
              </div>
            `;
        }).join('');

        checkoutTotalAmountSpan.textContent = `Rp ${parseFloat(totalHarga).toLocaleString()}`; // Tampilkan total harga di popup
        checkoutPopup.style.display = "flex"; // Tampilkan popup

        // Store itemsToCheckout and totalHarga temporarily in dataset for confirmCheckout
        checkoutPopup.dataset.items = JSON.stringify(itemsToCheckout);
        checkoutPopup.dataset.total = totalHarga; // Simpan total harga sebagai angka

        console.log('Checkout confirmation popup displayed.'); // Log
    }

    // Trigger checkout process for the main cart
    function checkout() {
       console.log('Initiating checkout from main cart.'); // Log
       processCheckout(keranjang); // Gunakan isi keranjang global
    }

    // Dipanggil saat tombol "Bayar Sekarang" di popup checkout diklik
    function confirmCheckout() {
        console.log('Confirming checkout...'); // Log
        // Ambil data dari dataset popup
        const itemsToCheckout = JSON.parse(document.getElementById('checkoutPopup').dataset.items || '[]');
        const totalHarga = parseFloat(document.getElementById('checkoutPopup').dataset.total || '0'); // Ambil total sebagai angka

        console.log('Retrieved data from checkout popup dataset - Items:', itemsToCheckout, 'Total:', totalHarga); // Log

        if (!itemsToCheckout || itemsToCheckout.length === 0 || totalHarga <= 0) { // Periksa juga total > 0
            console.warn("No items or zero total for checkout confirmation."); // Log
            alert("Tidak ada item untuk checkout.");
            closePopup('checkoutPopup');
            return;
        }

        const username = localStorage.getItem('loggedInUsername'); // Ambil username (opsional)
        const userId = localStorage.getItem('loggedInUserId'); // Ambil userId (penting)

        console.log('Attempting checkout backend call. Retrieved userId:', userId, 'Username:', username); // Log

        if (!userId) { // Cek hanya userId sebagai pengenal unik utama
            console.error('Checkout failed: userId is missing from localStorage. User not logged in?'); // Log error
            alert("Anda perlu login untuk melakukan checkout."); // Pesan lebih jelas
            closePopup('checkoutPopup');
            // Redirect ke halaman login mungkin lebih baik: window.location.href = "index.html";
            return;
        }

        console.log('Sending checkout request to login.php with action="checkout"'); // Log
        fetch('../backend/login.php', { // Pastikan URL ini benar
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'checkout', // Pastikan action ini terkirim
                userId: userId, // Kirim userId (disarankan)
                // username: username, // Opsional, jika backend hanya butuh userId
                items: itemsToCheckout.map(item => ({ // Kirim detail item yang diperlukan backend
                     id: parseInt(item.id), // Pastikan ID item dikirim sebagai angka
                     jumlah: parseInt(item.jumlah), // Pastikan jumlah dikirim sebagai angka
                     // Total per item tidak perlu dikirim jika backend menghitung ulang dari ID & jumlah
                     // Kirim total per item jika backend memerlukannya untuk verifikasi
                     total: parseFloat(item.total)
                })),
                totalAmount: parseFloat(totalHarga) // Kirim total amount sebagai angka
            })
        })
        .then(response => {
            console.log('Checkout backend response status:', response.status); // Log
             if (!response.ok) {
                 // Jika respons bukan OK, coba baca sebagai teks untuk debugging error server
                 return response.text().then(text => {
                      console.error('HTTP error during checkout. Response text:', text); // Log
                     let errorData = {};
                     try { errorData = JSON.parse(text); } catch(e) {} // Coba parse JSON jika mungkin
                     const error = new Error(errorData.message || `HTTP error! status: ${response.status}`);
                     error.status = response.status;
                     error.reason = errorData.reason;
                     error.backendResponse = errorData; // Simpan data error backend jika ada
                     throw error;
                 });
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received for checkout backend call:', data); // Log data aktual
            // backend/login.php action checkout mengembalikan { status: "success", message: "..." } atau { status: "error", message: "..." }
            if (data && data.status === 'success') { // Cek format sukses
                console.log('Checkout reported success by backend.'); // Log sukses
                alert('Checkout berhasil!');
                closePopup('checkoutPopup'); // Tutup popup checkout

                // Perbarui saldo setelah checkout berhasil
                updateSaldo(); // <<< Panggil update saldo di sini

                // Kosongkan keranjang utama jika checkout dari keranjang utama
                // Jika menggunakan beliLangsung, tempKeranjang tidak perlu dikosongkan dari sini
                // Asumsi: confirmCheckout selalu mengosongkan keranjang utama
                keranjang.length = 0;
                updateKeranjang(); // Perbarui tampilan keranjang (akan kosong)
                // toggleKeranjang(); // Tidak perlu menutup keranjang overlay jika checkout dari popup


                // Tampilkan popup sukses
                const successPopup = document.getElementById('successPopup');
                if(successPopup) successPopup.style.display = 'flex';

                setTimeout(() => {
                  if(successPopup) successPopup.style.display = 'none';
                }, 3000);

            } else if (data && data.status === 'error') { // Tangani error dari backend
                let errorMessage = data.message || 'Checkout gagal: Unknown error from backend';
                console.error('Backend reported checkout failure:', errorMessage, data); // Log error backend + data
                // alert(errorMessage); // Hapus alert bawaan browser
                // closePopup('checkoutPopup'); // Pindahkan penutupan popup ke dalam blok if/else di bawah

                 if (errorMessage.includes('Saldo tidak cukup') || (data.reason && data.reason === 'insufficient_saldo')) {
                   console.warn("Insufficient saldo error handled."); // Log
                   // Anda bisa menambahkan logika di sini untuk menampilkan popup Saldo Kurang jika backend menyediakan info saldo saat ini/dibutuhkan
                   // Saat ini backend hanya mengirim pesan "Saldo tidak cukup"

                   // === Tampilkan popup saldo kurang kustom ===
                   closePopup('checkoutPopup'); // Tutup popup checkout terlebih dahulu
                   const saldoPopup = document.getElementById('saldoPopup');
                   const requiredSaldoSpan = document.getElementById('required-saldo');
                   // const currentSaldoSpan = document.getElementById('current-saldo'); // Akan diupdate oleh updateSaldo()

                   // Perbarui saldo saat ini sebelum menampilkan popup
                   updateSaldo();

                   // Tampilkan total yang dibutuhkan di popup
                   if(requiredSaldoSpan) {
                     requiredSaldoSpan.textContent = `Rp ${parseFloat(totalHarga).toLocaleString('id-ID')}`;
                   }

                   // Tampilkan popup
                   if (saldoPopup) {
                     saldoPopup.style.display = 'flex';
                     console.log('Custom saldo insufficient popup displayed.'); // Log
                   } else {
                      console.error('Saldo popup element (#saldoPopup) not found!'); // Log error jika elemen tidak ada
                      // Fallback ke alert jika popup tidak ditemukan
                      alert(errorMessage);
                   }
                 }
                // Tangani error backend spesifik lainnya jika ada
            }
             else { // Tangani format respons backend yang tidak terduga
                  console.error('Checkout failed: Unexpected backend response format', data); // Log data tidak terduga
                  alert('Checkout gagal: Format respons server tidak terduga.');
                  closePopup('checkoutPopup');
             }
        })
        .catch(error => {
            console.error('Error during checkout fetch:', error); // Log error fetch
            let errorMessage = 'Terjadi kesalahan saat checkout. Silakan coba lagi.';

             if (error.message.includes('HTTP error!')) {
                 errorMessage = `Error server: ${error.message}`;
             } else if (error.message.includes('Failed to fetch')) {
                 errorMessage = 'Gagal terhubung ke server.';
             } else if (error.backendResponse && error.backendResponse.message) {
                 // Jika error berasal dari respons backend dengan format status/message
                 errorMessage = error.backendResponse.message;
             } else {
                  errorMessage = error.message; // Tampilkan pesan error umum
             }

             alert(errorMessage);
             closePopup('checkoutPopup'); // Tutup popup checkout
        });
    }

    // Function to update saldo display by fetching from backend
    function updateSaldo() {
        console.log('Attempting to update saldo...'); // Log
        // Mengambil userId dari localStorage dengan kunci yang benar
        const userId = localStorage.getItem('loggedInUserId'); // Mengambil dari localStorage
        if (!userId) {
            console.error('User ID not found in localStorage for saldo update.'); // Log
            document.getElementById('saldo').textContent = `Rp 0`; // Tampilkan 0 atau pesan error
            const currentSaldoSpan = document.getElementById('current-saldo'); // Untuk popup saldo kurang
            if (currentSaldoSpan) { currentSaldoSpan.textContent = `Rp 0`;}
            return;
        }

        console.log('Fetching saldo via login.php with action="get_saldo" for userId:', userId); // Log
        fetch('../backend/login.php', {
             method: 'POST',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ action: 'get_saldo', userId: userId }) // Kirim HANYA userId
        })
        .then(response => {
            console.log('Fetch saldo response status:', response.status); // Log
            if (!response.ok) {
                 return response.text().then(text => {
                     console.error('HTTP error fetching saldo. Response text:', text); // Log
                     throw new Error(`HTTP error! status: ${response.status}, Response: ${text}`);
                 });
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received for saldo:', data); // Log data aktual
            // backend/login.php action get_saldo mengembalikan {"saldo": jumlah} atau {"status": "error", "message": "..."}
            if (data && typeof data.saldo === 'number') { // Cek format sukses
                console.log('Saldo data format looks valid.'); // Log
                document.getElementById('saldo').textContent = `Rp ${parseInt(data.saldo).toLocaleString()}`;
                 // Update saldo di popup saldo kurang juga
                 const currentSaldoSpan = document.getElementById('current-saldo');
                 if (currentSaldoSpan) { currentSaldoSpan.textContent = `Rp ${parseInt(data.saldo).toLocaleString()}`;}
                 console.log('Saldo display updated successfully.'); // Log sukses update UI
            } else if (data && data.status === 'error') { // Tangani error dari backend
                console.error('Backend reported error fetching saldo:', data.message, data); // Log error backend + data
                document.getElementById('saldo').textContent = `Rp Error`; // Tampilkan pesan error umum di UI
                 const currentSaldoSpan = document.getElementById('current-saldo');
                 if (currentSaldoSpan) { currentSaldoSpan.textContent = `Rp Error`;}
                // Opsional: Tampilkan alert atau pesan error lebih detail di UI
            }
             else { // Tangani format data yang tidak valid atau null
                console.error('Failed to fetch saldo: Invalid data format from backend', data); // Log data tidak valid
                document.getElementById('saldo').textContent = 'Rp ???'; // Tampilkan placeholder
                 const currentSaldoSpan = document.getElementById('current-saldo');
                 if (currentSaldoSpan) { currentSaldoSpan.textContent = 'Rp ???';}
            }
        })
        .catch(error => {
            console.error('Error fetching saldo:', error); // Log error fetch
            document.getElementById('saldo').textContent = `Rp Fetch Error`; // Tampilkan error umum
             const currentSaldoSpan = document.getElementById('current-saldo');
             if (currentSaldoSpan) { currentSaldoSpan.textContent = `Rp Error`;}
            // Opsional: Tampilkan alert atau pesan error lebih detail
        });
    }


    function closePopup(popupId) {
      console.log('Closing popup:', popupId); // Log
      const popup = document.getElementById(popupId);
      if (popup) { // Pastikan elemen popup ada
           popup.style.display = "none";
      } else {
           console.error('Popup element not found:', popupId); // Log error
      }

      // Clear temporary items data when checkout popup is closed
      if (popupId === 'checkoutPopup') {
           const checkoutPopup = document.getElementById('checkoutPopup');
           if(checkoutPopup) { // Pastikan popup ada
                delete checkoutPopup.dataset.items;
                delete checkoutPopup.dataset.total; // Hapus total juga
           }
      }
    }

    // Close popup when clicking outside
    window.onclick = function(event) {
      // Cek apakah target klik ada dan memiliki classList sebelum menggunakan contains
      if (event.target && event.target.classList && event.target.classList.contains('popup-overlay')) {
        closePopup(event.target.id); // Use the ID of the clicked overlay to close the specific popup
      }
    }

    function tambahSaldo() {
      console.log('Redirecting to saldo.html'); // Log
      // This will now just link to the saldo page, where top-up logic resides
      window.location.href = "saldo.html";
    }

    // Functions for profile info popup (added previously)
    function showProfileInfoPopup() {
        console.log('Showing profile info popup'); // Log
        // Close the dropdown first
        const profileDropdown = document.getElementById("profileDropdown");
        if (profileDropdown) profileDropdown.classList.remove("active");


        // Get user data (using placeholders or localStorage as available)
        const username = localStorage.getItem('loggedInUsername') || 'Pengguna KantinITH'; // Default username
        const role = localStorage.getItem('loggedInUserRole') || 'Pembeli'; // Default role
        // *** PENTING: Ganti dengan pengambilan data profil aktual dari backend/API jika tersedia ***
        // Anda perlu membuat endpoint backend untuk mengambil detail profil berdasarkan userId/username
        // Untuk saat ini, gunakan placeholder
        const email = localStorage.getItem('loggedInUserEmail') || 'Belum Tersedia'; // Placeholder
        const phone = localStorage.getItem('loggedInUserPhone') || 'Belum Tersedia'; // Placeholder
        // Tambahkan pengambilan data lain jika diperlukan

        // Populate the popup with data
        const profileInfoUserName = document.getElementById('profileInfoUserName');
        const profileInfoUserRole = document.getElementById('profileInfoUserRole');
        const profileInfoEmail = document.getElementById('profileInfoEmail');
        const profileInfoPhone = document.getElementById('profileInfoPhone');
        const profileInfoPopup = document.getElementById('profileInfoPopup');

        if(profileInfoUserName) profileInfoUserName.textContent = username;
        if(profileInfoUserRole) profileInfoUserRole.textContent = role;
        if(profileInfoEmail) profileInfoEmail.textContent = email; // Update dengan email aktual jika ada
        if(profileInfoPhone) profileInfoPhone.textContent = phone; // Update dengan nomor telepon aktual jika ada
        // Populate other fields if added in HTML

        // Show the profile info popup
        if(profileInfoPopup) profileInfoPopup.style.display = 'flex';

        console.log('Profile info popup displayed with data:', {username, role, email, phone}); // Log
    }

     // Toggle profile dropdown (di topbar)
     function toggleProfile() {
         console.log('Toggling profile dropdown'); // Log
         const dropdown = document.getElementById('profileDropdown');
         if(dropdown) { // Pastikan elemen ada
             dropdown.classList.toggle('active');
              console.log('Profile dropdown state:', dropdown.classList.contains('active') ? 'Open' : 'Closed'); // Log
         } else {
             console.error('Profile dropdown element not found!'); // Log
         }
     }

    // Close dropdown when clicking outside (Adjusted for better handling)
    window.addEventListener('click', function(event) {
        const profileDropdown = document.getElementById('profileDropdown');
        const profileIconArea = document.querySelector('.profile'); // Area klik ikon/nama profil
        // Periksa apakah elemen ada sebelum menggunakan contains
        const isClickInsideDropdown = profileDropdown && profileDropdown.contains(event.target);
        const isClickOnProfileArea = profileIconArea && profileIconArea.contains(event.target);

        // Jika klik terjadi di luar dropdown DAN di luar area ikon/nama profil, tutup dropdown
        if (profileDropdown && profileDropdown.classList.contains('active') && !isClickInsideDropdown && !isClickOnProfileArea) {
             console.log('Clicked outside profile dropdown, closing.'); // Log
             profileDropdown.classList.remove('active');
        }
    });


    function logout() {
      console.log('Initiating logout'); // Log
      // Tampilkan popup logout
      const logoutPopup = document.getElementById('logoutPopup');

      if (logoutPopup) {
        logoutPopup.style.display = 'flex';
      }
    }

    function confirmLogout() {
      console.log('Confirming logout...'); // Log
      // Bersihkan localStorage
      localStorage.clear();
      // Arahkan ke halaman login
      window.location.href = "../index.html";
    }

    function showLogout() {
        console.log('Showing seller logout popup'); // Log
        const logoutPopup = document.getElementById('logoutPopup');
        const userNameElement = document.getElementById('sellerLogoutUserName'); // <--- Elemen untuk username
        const userRoleElement = document.getElementById('sellerLogoutUserRole'); // <--- Elemen untuk role

        // Ambil username dan role dari localStorage
        const loggedInUsername = localStorage.getItem('loggedInUsername') || 'Penjual'; // <--- Mengambil dari localStorage
        const loggedInUserRole = localStorage.getItem('loggedInUserRole') || ''; // Ambil role jika disimpan

        // Isi elemen di popup
        if (userNameElement) userNameElement.textContent = loggedInUsername; // <--- Memasukkan username ke elemen
        // Isi role hanya jika elemen ada dan role tersedia
        if (userRoleElement && loggedInUserRole) userRoleElement.textContent = loggedInUserRole;

        if (logoutPopup) {
            logoutPopup.style.display = 'flex'; // Tampilkan popup overlay
        }
    }
  </script>

<!-- Tombol Checkout -->
<button onclick="tampilkanCheckout()">Lihat Keranjang</button>

<!-- Modal Checkout -->
<div id="checkoutModal" style="display:none;">
  <h2>Keranjang</h2>
  <ul id="daftarKeranjang"></ul>
  <p>Total: <span id="totalHarga">Rp0</span></p>
  <button onclick="prosesCheckout()">Checkout</button>
</div>

</body>
</html>
